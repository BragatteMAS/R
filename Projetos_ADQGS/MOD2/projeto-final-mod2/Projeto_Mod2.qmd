---
title: "projeto_final_mod2"
author: "nome aqui"
format: html
editor: visual
---

# Projeto de vigilância Mod2

## **Porque** desta atividade?

Praticar as habilidades ensinadas no curso em projeto com dados reais de pesquisa na área de saúde, neste exemplo com dados do SUS - **SIM** (Sistema de Informações de Mortalidade).

Nesta pesquisa queremos averiguar as transformações dos dados da vigilância na coorte de indivíduos da população brasileira e sua capacidade de editar códigos.

## Como

Seguir as instruções abaixo:

-   Cada discente deverá fazer as mudanças nos locais indicados alterando o período das análises, para cobrir todo o ano de 2022 no exemplo (que não compreende todo o ano), você precisa **seguir o tutorial e modificar o filtro para o período correto que esta atribuído a você !!!!!!!!!!!!!!!!!!**

-   **Criar um projeto no Rstudio**, contendo o script e os arquivos de dados do exercício com seu nome *e*

-   **Fazer um script/quarto** realizando as tarefas abaixo

    -   devem copiar e colar, editando partes de interesse

### Configurações do Projeto

##### opcionais

para ajusar renderização

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, error = FALSE, warning = FALSE, message = FALSE, results = 'asis')
```

também pode ser usado este comando para limpar a memória do R, o que as vezes causa erros

```{r}
rm()
```

#### Definir local projeto

Salvar local onde terão os arquivos para meu projeto usar

Onde estou?

```{r}
getwd() # aqui será mostrado o seu local no computador
```

##### **Definir NOME DA PASTA DO SEU COMPUTADOR AQUI (pode copiar a de cima mostrado com \`getwd\` se o lugar estiver ok para você)**

Onde quero trabalhar com os arquivos no computador?

```{r}
pasta_proj_mod2 <-"~/Documents/GitHub/R/Projetos_ADQGS/projeto-final-mod2/" # colar o seui local do computador entre as "\usuário\documentos\projetoR" por exemplo se for no windows 
```

Definir local para buscar os dados

```{r}
setwd(pasta_proj_mod2)
```

## Mãos a obra - parte técnica

### Instalar e carregar pacotes

Para garantir e facilitar o processo, vamos instalar no Rstudio o pacote `pacman` que instala e carrega automaticamente os demais pacotes e suas bibliotecas.

```{r}
## Bibliotecas
pacman::p_load(devtools, microdatasus, vroom, janytor, tidyverse, tidytable, lubridate, plotly, zoo)
## explicações dos pacotes
### devtools = carregar bibliotecas fora do CRAN
### microdatasus = carregar dados do SUS automaticamente
### vroom  = ler arquivos rápido e prático
### tidyverse e tidytable = manipular dados
### lubridate = corrigir e manipular datas
### plotly = gerar gráficos interativos
### zoo = calcular média móvel fácil
### gridExtra = múltiplos gráficos juntos - facet fácil
```

```{r}
## caso pacote microdatasus falhe na instalação anterior, descomentar linha abaixo
# devtools::install_github("rfsaldanha/microdatasus", force = T)
```

### **O que** podemos fazer com os dados do SUS ?

Realizar transformações versáteis que facilitam análises de dados para diferentes estudos:

-   Manipulação

-   Exemplos de análises possíveis com os dados do SUS:

    -   Descritivas

    -   Temporias

    -   Espaciais

    -   Clusters

    -   Fatores de Risco\
        (Risco Relativo e Razão de Chances em coortes e casos-controles)

    -   Modelagens de doenças infecciosas

-   Em resumo as análises devem conter:

    -   PESSOA

    -   TEMPO

    -   LOCAL

### Dados SUS exemplo

##### SIM

-   Selecionar o ano de interesse - pode ser alterado para intervalos de tempo maiores
-   Esta parte descomentar somente se para exploração, pois arquivos são grandes, usar arquivo enviado

```{r}
## O que esta linha faz? Nome do nosso dado <- função do pacote(ano_início = 2021, ano_fim = 2023, mês_início = 01, mês_fim = 12, uf = ES, biblioteca do sus = SIM-DO)
#ES_Sim <- fetch_datasus(year_start = 2021, year_end = 2023, uf = "ES", information_system = "SIM-DO") # descomentar essa linha. se quiser ver o dad
## O que esta linha faz? Transforma dados numéricos em categóricos automaticamente conforme documentação do SUS
#ESpecial_Sim <- process_sim(ES_Sim) # descomentar essa linha. se quiser ver o dad
```

##### SINAN-Dengue

Carregamento opcional

```{r}
## Apenas para quem quiser dar uma olhada nos dados de Dengue
## O que esta linha faz? Chamando dados do SINAN-Dengue para ter outro exemplo
# ES_Sinan <- fetch_datasus(year_start = 2022, year_end = 2023, uf = "ES", information_system = "SINAN-DENGUE") # descomentar essa linha. se quiser ver o dado
## aqui demora mesmo para carregar, muitos dados
# ESpecial_Sinan <- process_sinan_dengue(ES_Sinan)  # descomentar essa linha. se quiser ver o dad
```

### Manipulando os dados exemplo

dar nome = -\> ("Alt" + "-")

`` Estes símbolos chamado de pipe `%>% ou |>`, podem ser lidos como "então". `` então = \|\> ("Ctrl" + "Shift" + "M")

```{r}
ES_sim <- vroom("ES_Sim.csv")
```

# Exercício 1. colocar seu nome ao final do arquivo

```{r}
## Como salvar arquivos em CSV? Usar a funça0 `write.csv`
write.csv(ES_sim, file = "ES_Sim_NOME.csv", row.names = FALSE) # ALTERAR NOME DO ARQUIVO SALVO AQUI ES_Sim_Bragatte.csv por exemplo
# write.csv(ESpecial_Sim, file = "ESpecial_Sim.csv", row.names = FALSE)
## Como salvar arquivos em EXCEL? Usar a funçao `write_excel_csv`
# write_excel_csv(ESpecial_Sim, file = "ESpecial_Sim.xlsx") # descomentar essa linha. se quiser ver o dad
# write_excel_csv(ESpecial_Sinan, file = "ESpecial_Sinan.xlsx")
```

```{r}
## limpeza dos nomes das colunas, para copiar mais fácil
ES_sim <- ES_sim |> 
    janitor::clean_names()
colnames(ES_sim) # no momento as colunas estão como fatores <fct>
```

```{r}
## corrgir formato das datas
ES_sim$dtobito <- dmy(ES_sim$dtobito) #linha1
```

```{r}
## Exemplo de prepação de dataset
## qual novo nome
mortES <-
    ## qual arquivo original
    ES_sim |>
    ## modificações de interesse
    mutate.(
        tipobito2 = case_when(tipobito == 1 ~ "Fetal",
                              tipobito == 2 ~ "Não Fetal"),
        tobito = ymd(dtobito),
        dtnasc = ymd(dtnasc)
    )  |>
    ## quais colunas eu quero
    select.(tipobito,
            tipobito2,
            dtobito,
            dtnasc,
            idade,
            sexo,
            racacor,
            estciv,
            esc,
            causabas)
```

## Praticando fitlros novos com plots de projetos do Mod1

## Mundo e países

biblioteca vroom é similar a biblioteca reader

```{r}
covid_mundo <- vroom("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv")
```

```{r}
## avaliando o dado
#str(covid_mundo)
#summary(covid_mundo)
```

## Estados e Municipíos do Brasil

```{r}
gov_br_estados <- vroom("https://raw.githubusercontent.com/wcota/covid19br/master/cases-brazil-states.csv")

gov_br_municipios <- vroom("https://raw.githubusercontent.com/wcota/covid19br/master/cases-brazil-cities.csv")
```

# Exercício 2 filtrar todo o ano de 2022 nos gráficos

## Nível Brasil:

Revisando média móvel

```{r}
## qual novo nome 
covid_br <-
    ## qual arquivo original
    covid_mundo |>     
    ## quais colunas eu quero
    select(location, date, new_cases, new_cases_smoothed ,new_deaths, new_deaths_smoothed) |>
    ## quais filtros quero aplicar
    filter(location == "Brazil",
            between.(date, as.Date('2022-01-01'),
                    as.Date('2022-11-19'))) |> # aqui mudar a data 2022-12-31
    ## colunas de média móvel 7
    mutate(m.movel.7_casos = round(rollmean(new_cases, k = 7, fill = NA, align = "right"))) |> 
    mutate(m.movel.7_mortes = round(rollmean(new_deaths, k = 7, fill = NA, align = "right")))

## substituindo valores NA por 0
covid_br[is.na(covid_br)] <- 0

#covid_br
```

## Média do ano de 2022 até novembro - mudar para todo 2022

Fazer isso para todo 2022

```{r}
## calculando  média de casos de covid primeiro em 2022
media_casos <- mean (covid_br$new_cases)

## arredondamento
round(media_casos)

## calculando média de óbitos de covid primeiro em 2022
media_obitos <- mean (covid_br$new_deaths)

## arredondamento
round(media_obitos)
```

## Estados / Municípios

```{r}
## qual novo nome 
gov_br_est <- 
    ## qual arquivo original
    gov_br_estados |> 
    ## quais colunas eu quero
    select.(country, state, epi_week, date, newCases ,newDeaths) |> 
    ## quais filtros quero aplicar
    filter.(state == "ES",
            between.(date, as.Date('2022-01-01'),
                    as.Date('2022-11-19'))) |> # aqui mudar a data 2022-12-31
    ## colunas de média móvel 7
    mutate.(m.movel.7_casos = round(rollmean(newCases, k = 7, fill = NA, align = "right"))) |> 
    mutate.(m.movel.7_mortes = round(rollmean(newDeaths, k = 7, fill = NA, align = "right")))

## substituindo valores NA por 0
gov_br_est[is.na(covid_br)] <- 0

#gov_br_est
```

## Comunicar c/ gráficos

## Casos BR

```{r}
## comentar quando for gerar relatório
#esquisser(covid_br)
```

# Exercício 3 trocar as cores dos gráficos

```{r}
## dado
casos_br <- ggplot(covid_br) +
    ## mapa
    aes(x = date, y = new_cases, fill = location) +
    ## geometria
    geom_area(color = "yellow") + #AQUI TROCA A COR
    geom_line(aes(x = date, y = m.movel.7_casos , col = 'Casos Diários'), lwd = 0.4, color = "green") +  #AQUI TROCA A COR
    ## formatações
    scale_fill_manual(values = c(Brazil = "yellow")) +  #AQUI TROCA A COR
    labs(x = "2022",
         y = "Média móvel casos Br",
         title = "Casos covid Br") +
    theme_classic()

casos_br 
```

## Casos ES

```{r}
## comentar quando for gerar relatório
#esquisser(gov_br_est)
```

```{r}
## dado
casos_es <- ggplot(gov_br_est) +
    ## mapa
    aes(x = date, y = newCases, fill = state) +
    ## geometria
    geom_area(color = "pink") +  #AQUI TROCA A COR
    geom_line(aes(x = date, y = m.movel.7_casos , col = 'Casos Diários'), lwd = 0.4, color = "blue") +  #AQUI TROCA A COR
    ## formatações
    scale_fill_hue(direction = 1) +
    labs(x = "2022",
         y = "Media Movel casos ES",
         title = "Casos de covid no ES") +
    theme_minimal()

casos_es
```

## Transformando em gráficos interativo

```{r}
## pacote plotly
ggplotly(casos_br)
ggplotly(casos_es)
```

## 

# Exercício 4 responder a pergunta

**Colocar um parágrafo de conclusão sobre o exercício e sobre perspectivas de aplicação da análise de vigilancia em sua rotina, uma frase:**

R:

\
Não estamos esperando um modelo de resposta ideal, o objetivo é vocês praticarem o método científico e aplicar os aprendizados no R, gerando um relatório ao final (no RStudio clicar no botão Render).

Devem usar este arquivo como referência.\
\
Entregar o arquivo com seu script "Projeto_Mod2_NOME.qmd"\
\
Bom trabalho e semana.\

## Ref

-   [Transferência de Arquivos -- DATASUS](https://datasus.saude.gov.br/transferencia-de-arquivos/#)

-   [rfsaldanha/microdatasus: Download de dados do DataSUS e pré-processamento no R.](https://github.com/rfsaldanha/microdatasus)
